define(["durandal/system","durandal/app","durandal/composition","durandal/activator","durandal/viewEngine","jquery","knockout"],function(n,t,i,r,u,f,e){function l(t){return n.defer(function(i){n.isString(t)?n.acquire(t).then(function(t){i.resolve(n.resolveObject(t))}).fail(function(i){n.error("Failed to load dialog module ("+t+"). Details: "+i.message)}):i.resolve(t)}).promise()}var h={},c=0,o,s=function(n,t,i){this.message=n;this.title=t||s.defaultTitle;this.options=i||s.defaultOptions};return s.prototype.selectOption=function(n){o.close(this,n)},s.prototype.getView=function(){return u.processMarkup(s.defaultViewMarkup)},s.setViewUrl=function(n){delete s.prototype.getView;s.prototype.viewUrl=n},s.defaultTitle=t.title||"Application",s.defaultOptions=["Ok"],s.defaultViewMarkup='<div data-view="plugins/messageBox" class="messageBox">\n<div class="modal-header">\n<h3 data-bind="text: title"><\/h3>\n<\/div>\n<div class="modal-body">\n<p class="message" data-bind="text: message"><\/p>\n<\/div>\n<div class="modal-footer" data-bind="foreach: options">\n<button class="btn" data-bind="click: function () { $parent.selectOption($data); }, text: $data, css: { \'btn-primary\': $index() == 0, autofocus: $index() == 0 }"><\/button>\n<\/div>\n<\/div>',o={MessageBox:s,currentZIndex:1050,getNextZIndex:function(){return++this.currentZIndex},isOpen:function(){return c>0},getContext:function(n){return h[n||"default"]},addContext:function(n,t){t.name=n;h[n]=t;var i="show"+n.substr(0,1).toUpperCase()+n.substr(1);this[i]=function(t,i){return this.show(t,i,n)}},createCompositionSettings:function(n,t){var i={model:n,activate:!1,transition:!1};return t.attached&&(i.attached=t.attached),t.compositionComplete&&(i.compositionComplete=t.compositionComplete),i},getDialog:function(n){return n?n.__dialog__:undefined},close:function(n){var t=this.getDialog(n),i;t&&(i=Array.prototype.slice.call(arguments,1),t.close.apply(t,i))},show:function(t,u,f){var o=this,e=h[f||"default"];return n.defer(function(n){l(t).then(function(t){var f=r.create();f.activateItem(t,u).then(function(r){if(r){var u=t.__dialog__={owner:t,context:e,activator:f,close:function(){var i=arguments;f.deactivateItem(t,!0).then(function(r){r&&(c--,e.removeHost(u),delete t.__dialog__,i.length===0?n.resolve():i.length===1?n.resolve(i[0]):n.resolve.apply(n,i))})}};u.settings=o.createCompositionSettings(t,e);e.addHost(u);c++;i.compose(u.host,u.settings)}else n.resolve(!1)})})}).promise()},showMessage:function(t,i,r){return n.isString(this.MessageBox)?o.show(this.MessageBox,[t,i||s.defaultTitle,r||s.defaultOptions]):o.show(new this.MessageBox(t,i,r))},install:function(n){t.showDialog=function(n,t,i){return o.show(n,t,i)};t.showMessage=function(n,t,i){return o.showMessage(n,t,i)};n.messageBox&&(o.MessageBox=n.messageBox);n.messageBoxView&&(o.MessageBox.prototype.getView=function(){return n.messageBoxView})}},o.addContext("default",{blockoutOpacity:.2,removeDelay:200,addHost:function(n){var t=f("body"),u=f('<div class="modalBlockout"><\/div>').css({"z-index":o.getNextZIndex(),opacity:this.blockoutOpacity}).appendTo(t),e=f('<div class="modalHost"><\/div>').css({"z-index":o.getNextZIndex()}).appendTo(t),r;if(n.host=e.get(0),n.blockout=u.get(0),!o.isOpen()){n.oldBodyMarginRight=t.css("margin-right");n.oldInlineMarginRight=t.get(0).style.marginRight;var i=f("html"),s=t.outerWidth(!0),h=i.scrollTop();f("html").css("overflow-y","hidden");r=f("body").outerWidth(!0);t.css("margin-right",r-s+parseInt(n.oldBodyMarginRight,10)+"px");i.scrollTop(h)}},removeHost:function(n){if(f(n.host).css("opacity",0),f(n.blockout).css("opacity",0),setTimeout(function(){e.removeNode(n.host);e.removeNode(n.blockout)},this.removeDelay),!o.isOpen()){var t=f("html"),i=t.scrollTop();t.css("overflow-y","").scrollTop(i);n.oldInlineMarginRight?f("body").css("margin-right",n.oldBodyMarginRight):f("body").css("margin-right","")}},attached:function(n){f(n).css("visibility","hidden")},compositionComplete:function(n,t,i){var u=o.getDialog(i.model),r=f(n),s=r.find("img").filter(function(){var n=f(this);return!(this.style.width&&this.style.height)&&!(n.attr("width")&&n.attr("height"))}),e;r.data("predefinedWidth",r.get(0).style.width);e=function(){setTimeout(function(){r.data("predefinedWidth")||r.css({width:""});var n=r.outerWidth(!1),t=r.outerHeight(!1),i=f(window).height(),e=Math.min(t,i);r.css({"margin-top":(-e/2).toString()+"px","margin-left":(-n/2).toString()+"px"});r.data("predefinedWidth")||r.outerWidth(n);t>i?r.css("overflow-y","auto"):r.css("overflow-y","");f(u.host).css("opacity",1);r.css("visibility","visible");r.find(".autofocus").first().focus()},1)};e();s.load(e);r.hasClass("autoclose")&&f(u.blockout).click(function(){u.close()})}}),o});