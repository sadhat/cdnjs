define(["durandal/system","knockout"],function(n,t){function f(n){return n==undefined&&(n={}),n.closeOnDeactivate||(n.closeOnDeactivate=i.defaults.closeOnDeactivate),n.beforeActivate||(n.beforeActivate=i.defaults.beforeActivate),n.afterDeactivate||(n.afterDeactivate=i.defaults.afterDeactivate),n.affirmations||(n.affirmations=i.defaults.affirmations),n.interpretResponse||(n.interpretResponse=i.defaults.interpretResponse),n.areSameItem||(n.areSameItem=i.defaults.areSameItem),n}function r(t,i,r){return n.isArray(r)?t[i].apply(t,r):t[i](r)}function u(t,i,r,u,f){if(t&&t.deactivate){n.log("Deactivating",t);var e;try{e=t.deactivate(i)}catch(o){n.error(o);u.resolve(!1);return}e&&e.then?e.then(function(){r.afterDeactivate(t,i,f);u.resolve(!0)},function(t){n.log(t);u.resolve(!1)}):(r.afterDeactivate(t,i,f),u.resolve(!0))}else t&&r.afterDeactivate(t,i,f),u.resolve(!0)}function e(t,i,u,f){if(t)if(t.activate){n.log("Activating",t);var e;try{e=r(t,"activate",f)}catch(o){n.error(o);u(!1);return}e&&e.then?e.then(function(){i(t);u(!0)},function(t){n.log(t);u(!1)}):(i(t),u(!0))}else i(t),u(!0);else u(!0)}function o(t,i,r){return r.lifecycleData=null,n.defer(function(u){if(t&&t.canDeactivate){var f;try{f=t.canDeactivate(i)}catch(e){n.error(e);u.resolve(!1);return}f.then?f.then(function(n){r.lifecycleData=n;u.resolve(r.interpretResponse(n))},function(t){n.error(t);u.resolve(!1)}):(r.lifecycleData=f,u.resolve(r.interpretResponse(f)))}else u.resolve(!0)}).promise()}function s(t,i,u,f){return u.lifecycleData=null,n.defer(function(e){if(t==i()){e.resolve(!0);return}if(t&&t.canActivate){var o;try{o=r(t,"canActivate",f)}catch(s){n.error(s);e.resolve(!1);return}o.then?o.then(function(n){u.lifecycleData=n;e.resolve(u.interpretResponse(n))},function(t){n.error(t);e.resolve(!1)}):(u.lifecycleData=o,e.resolve(u.interpretResponse(o)))}else e.resolve(!0)}).promise()}function h(i,r){var c=t.observable(null),l,h;return r=f(r),h=t.computed({read:function(){return c()},write:function(n){h.viaSetter=!0;h.activateItem(n)}}),h.__activator__=!0,h.settings=r,r.activator=h,h.isActivating=t.observable(!1),h.canDeactivateItem=function(n,t){return o(n,t,r)},h.deactivateItem=function(t,i){return n.defer(function(n){h.canDeactivateItem(t,i).then(function(f){f?u(t,i,r,n,c):(h.notifySubscribers(),n.resolve(!1))})}).promise()},h.canActivateItem=function(n,t){return s(n,c,r,t)},h.activateItem=function(t,i){var f=h.viaSetter;return h.viaSetter=!1,n.defer(function(o){if(h.isActivating()){o.resolve(!1);return}h.isActivating(!0);var s=c();if(r.areSameItem(s,t,l,i)){h.isActivating(!1);o.resolve(!0);return}h.canDeactivateItem(s,r.closeOnDeactivate).then(function(a){a?h.canActivateItem(t,i).then(function(a){a?n.defer(function(n){u(s,r.closeOnDeactivate,r,n)}).promise().then(function(){t=r.beforeActivate(t,i);e(t,c,function(n){l=i;h.isActivating(!1);o.resolve(n)},i)}):(f&&h.notifySubscribers(),h.isActivating(!1),o.resolve(!1))}):(f&&h.notifySubscribers(),h.isActivating(!1),o.resolve(!1))})}).promise()},h.canActivate=function(){var n;return i?(n=i,i=!1):n=h(),h.canActivateItem(n)},h.activate=function(){var n;return i?(n=i,i=!1):n=h(),h.activateItem(n)},h.canDeactivate=function(n){return h.canDeactivateItem(h(),n)},h.deactivate=function(n){return h.deactivateItem(h(),n)},h.includeIn=function(n){n.canActivate=function(){return h.canActivate()};n.activate=function(){return h.activate()};n.canDeactivate=function(n){return h.canDeactivate(n)};n.deactivate=function(n){return h.deactivate(n)}},r.includeIn?h.includeIn(r.includeIn):i&&h.activate(),h.forItems=function(t){var i,u;return r.closeOnDeactivate=!1,r.determineNextItemToActivate=function(n,t){var i=t-1;return i==-1&&n.length>1?n[1]:i>-1&&i<n.length-1?n[i]:null},r.beforeActivate=function(n){var u=h(),i;return n?(i=t.indexOf(n),i==-1?t.push(n):n=t()[i]):n=r.determineNextItemToActivate(t,u?t.indexOf(u):0),n},r.afterDeactivate=function(n,i){i&&t.remove(n)},i=h.canDeactivate,h.canDeactivate=function(r){return r?n.defer(function(n){function e(){for(var t=0;t<i.length;t++)if(!i[t]){n.resolve(!1);return}n.resolve(!0)}for(var u=t(),i=[],f=0;f<u.length;f++)h.canDeactivateItem(u[f],r).then(function(n){i.push(n);i.length==u.length&&e()})}).promise():i()},u=h.deactivate,h.deactivate=function(i){return i?n.defer(function(n){function o(r){h.deactivateItem(r,i).then(function(){f++;t.remove(r);f==e&&n.resolve()})}for(var u=t(),f=0,e=u.length,r=0;r<e;r++)o(u[r])}).promise():u()},h},h}var i,c={closeOnDeactivate:!0,affirmations:["yes","ok","true"],interpretResponse:function(i){return(n.isObject(i)&&(i=i.can||!1),n.isString(i))?t.utils.arrayIndexOf(this.affirmations,i.toLowerCase())!==-1:i},areSameItem:function(n,t){return n==t},beforeActivate:function(n){return n},afterDeactivate:function(n,t,i){t&&i&&i(null)}};return i={defaults:c,create:h,isActivator:function(n){return n&&n.__activator__}}});