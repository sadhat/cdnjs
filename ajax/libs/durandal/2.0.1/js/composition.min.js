define(["durandal/system","durandal/viewLocator","durandal/binder","durandal/viewEngine","durandal/activator","jquery","knockout"],function(n,t,i,r,u,f,e){function it(n){for(var r=[],i={childElements:r,activeView:null},t=e.virtualElements.firstChild(n);t;)t.nodeType==1&&(r.push(t),t.getAttribute(a)&&(i.activeView=t)),t=e.virtualElements.nextSibling(t);return i.activeView||(i.activeView=r[0]),i}function c(){h--;h===0&&setTimeout(function(){for(var t=s.length;t--;)try{s[t]()}catch(i){n.error(i)}s=[]},1)}function l(n){delete n.activeView;delete n.viewElements}function rt(t,i,r){if(r)i();else if(t.activate&&t.model&&t.model.activate){var u;try{u=n.isArray(t.activationData)?t.model.activate.apply(t.model,t.activationData):t.model.activate(t.activationData);u&&u.then?u.then(i,function(t){n.error(t);i()}):u||u===undefined?i():(c(),l(t))}catch(f){n.error(f)}}else i()}function ut(){var t=this;if(t.activeView&&t.activeView.removeAttribute(a),t.child)try{t.model&&t.model.attached&&(t.composingNewView||t.alwaysTriggerAttach)&&t.model.attached(t.child,t.parent,t);t.attached&&t.attached(t.child,t.parent,t);t.child.setAttribute(a,!0);t.composingNewView&&t.model&&t.model.detached&&e.utils.domNodeDisposal.addDisposeCallback(t.child,function(){try{t.model.detached(t.child,t.parent,t)}catch(i){n.error(i)}})}catch(i){n.error(i)}t.triggerAttach=n.noop}function ft(t){if(n.isString(t.transition)){if(t.activeView){if(t.activeView==t.child)return!1;if(!t.child)return!0;if(t.skipTransitionOnSameViewId){var i=t.activeView.getAttribute("data-view"),r=t.child.getAttribute("data-view");return i!=r}}return!0}return!1}function y(n){for(var r,t=0,u=n.length,i=[];t<u;t++)r=n[t].cloneNode(!0),i.push(r);return i}function k(n){var r=y(n.parts),t=o.getParts(r,null,!0),u=o.getParts(n.child);for(var i in t)f(u[i]).replaceWith(t[i])}function d(t){var r=e.virtualElements.childNodes(t.parent),i,u,f;if(!n.isArray(r)){for(f=[],i=0,u=r.length;i<u;i++)f[i]=r[i];r=f}for(i=1,u=r.length;i<u;i++)e.removeNode(r[i])}function p(n){e.utils.domData.set(n,b,n.style.display);n.style.display="none"}function et(n){n.style.display=e.utils.domData.get(n,b)}function ot(n){var i=n.getAttribute("data-bind"),t,r;if(!i)return!1;for(t=0,r=v.length;t<r;t++)if(i.indexOf(v[t])>-1)return!0;return!1}var g={},a="data-active-view",o,s=[],h=0,w="durandal-composition-data",nt="data-part",tt=["model","view","transition","area","strategy","activationData"],b="durandal-visibility-data",v=["compose:"],st={complete:function(n){s.push(n)}};return o={composeBindings:v,convertTransitionToModuleId:function(n){return"transitions/"+n},defaultTransitionName:null,current:st,addBindingHandler:function(n,t,i){var r,u="composition-handler-"+n,f;t=t||e.bindingHandlers[n];i=i||function(){return undefined};f=e.bindingHandlers[n]={init:function(n,r,f,s,c){if(h>0){var l={trigger:e.observable(null)};o.current.complete(function(){t.init&&t.init(n,r,f,s,c);t.update&&(e.utils.domData.set(n,u,t),l.trigger("trigger"))});e.utils.domData.set(n,u,l)}else e.utils.domData.set(n,u,t),t.init&&t.init(n,r,f,s,c);return i(n,r,f,s,c)},update:function(n,t,i,r,f){var o=e.utils.domData.get(n,u);if(o.update)return o.update(n,t,i,r,f);o.trigger&&o.trigger()}};for(r in t)r!=="init"&&r!=="update"&&(f[r]=t[r])},getParts:function(n,t,i){var u,e,r,f;if(t=t||{},!n)return t;for(n.length===undefined&&(n=[n]),u=0,e=n.length;u<e;u++)if(r=n[u],r.getAttribute){if(!i&&ot(r))continue;f=r.getAttribute(nt);f&&(t[f]=r);!i&&r.hasChildNodes()&&o.getParts(r.childNodes,t)}return t},cloneNodes:y,finalize:function(t){var u,r;t.transition===undefined&&(t.transition=this.defaultTransitionName);t.child||t.activeView?ft(t)?(u=this.convertTransitionToModuleId(t.transition),n.acquire(u).then(function(n){t.transition=n;n(t).then(function(){if(t.cacheViews){if(t.activeView){var n=i.getBindingInstruction(t.activeView);n&&n.cacheViews!=undefined&&!n.cacheViews&&e.removeNode(t.activeView)}}else t.child?d(t):e.virtualElements.emptyNode(t.parent);t.triggerAttach();c();l(t)})}).fail(function(t){n.error("Failed to load transition ("+u+"). Details: "+t.message)})):(t.child!=t.activeView&&(t.cacheViews&&t.activeView&&(r=i.getBindingInstruction(t.activeView),r&&(r.cacheViews==undefined||r.cacheViews)?p(t.activeView):e.removeNode(t.activeView)),t.child?(t.cacheViews||d(t),et(t.child)):t.cacheViews||e.virtualElements.emptyNode(t.parent)),t.triggerAttach(),c(),l(t)):(t.cacheViews||e.virtualElements.emptyNode(t.parent),t.triggerAttach(),c(),l(t))},bindAndShow:function(n,t,u){t.child=n;t.composingNewView=t.cacheViews?e.utils.arrayIndexOf(t.viewElements,n)==-1:!0;rt(t,function(){if(t.binding&&t.binding(t.child,t.parent,t),t.preserveContext&&t.bindingContext)t.composingNewView&&(t.parts&&k(t),p(n),e.virtualElements.prepend(t.parent,n),i.bindContext(t.bindingContext,n,t.model));else if(n){var u=t.model||g,f=e.dataFor(n);if(f!=u){if(!t.composingNewView){e.removeNode(n);r.createView(n.getAttribute("data-view")).then(function(n){o.bindAndShow(n,t,!0)});return}t.parts&&k(t);p(n);e.virtualElements.prepend(t.parent,n);i.bind(u,n)}}o.finalize(t)},u)},defaultStrategy:function(n){return t.locateViewForObject(n.model,n.area,n.viewElements)},getSettings:function(t){var s=t(),i=e.utils.unwrapObservable(s)||{},o=u.isActivator(s),h,f;if(n.isString(i))return r.isViewUrl(i)?{view:i}:{model:i,activate:!0};if(h=n.getModuleId(i),h)return{model:i,activate:!0};!o&&i.model&&(o=u.isActivator(i.model));for(f in i)i[f]=e.utils.arrayIndexOf(tt,f)!=-1?e.utils.unwrapObservable(i[f]):i[f];return o?i.activate=!1:i.activate===undefined&&(i.activate=!0),i},executeStrategy:function(n){n.strategy(n).then(function(t){o.bindAndShow(t,n)})},inject:function(i){if(!i.model){this.bindAndShow(null,i);return}if(i.view){t.locateView(i.view,i.area,i.viewElements).then(function(n){o.bindAndShow(n,i)});return}i.strategy||(i.strategy=this.defaultStrategy);n.isString(i.strategy)?n.acquire(i.strategy).then(function(n){i.strategy=n;o.executeStrategy(i)}).fail(function(t){n.error("Failed to load view strategy ("+i.strategy+"). Details: "+t.message)}):this.executeStrategy(i)},compose:function(i,r,u,f){h++;f||(r=o.getSettings(function(){return r},i));r.compositionComplete&&s.push(function(){r.compositionComplete(r.child,r.parent,r)});s.push(function(){r.composingNewView&&r.model&&r.model.compositionComplete&&r.model.compositionComplete(r.child,r.parent,r)});var e=it(i);r.activeView=e.activeView;r.parent=i;r.triggerAttach=ut;r.bindingContext=u;r.cacheViews&&!r.viewElements&&(r.viewElements=e.childElements);r.model?n.isString(r.model)?n.acquire(r.model).then(function(t){r.model=n.resolveObject(t);o.inject(r)}).fail(function(t){n.error("Failed to load composed module ("+r.model+"). Details: "+t.message)}):o.inject(r):r.view?(r.area=r.area||"partial",r.preserveContext=!0,t.locateView(r.view,r.area,r.viewElements).then(function(n){o.bindAndShow(n,r)})):this.bindAndShow(null,r)}},e.bindingHandlers.compose={init:function(){return{controlsDescendantBindings:!0}},update:function(n,t,i,u,f){var s=o.getSettings(t,n),h,c;s.mode&&(h=e.utils.domData.get(n,w),h||(c=e.virtualElements.childNodes(n),h={},s.mode==="inline"?h.view=r.ensureSingleElement(c):s.mode==="templated"&&(h.parts=y(c)),e.virtualElements.emptyNode(n),e.utils.domData.set(n,w,h)),s.mode==="inline"?s.view=h.view.cloneNode(!0):s.mode==="templated"&&(s.parts=h.parts),s.preserveContext=!0);o.compose(n,s,f,!0)}},e.virtualElements.allowedBindings.compose=!0,o});