define(["durandal/system","durandal/app","durandal/activator","durandal/events","durandal/composition","plugins/history","knockout","jquery"],function(n,t,i,r,u,f,e,o){function c(n){return n=n.replace(b,"\\$&").replace(y,"(?:$1)?").replace(p,function(n,t){return t?n:"([^/]+)"}).replace(w,"(.*?)"),new RegExp("^"+n+"$")}function l(n){var t=n.indexOf(":"),i=t>0?t-1:n.length;return n.substring(0,i)}function a(n,t){return n.indexOf(t,n.length-t.length)!==-1}function d(n,t){if(!n||!t||n.length!=t.length)return!1;for(var i=0,r=n.length;i<r;i++)if(n[i]!=t[i])return!1;return!0}var y=/\((.*?)\)/g,p=/(\(\?)?:\w+/g,w=/\*\w+/g,b=/[\-{}\[\]+?.,\\\^$|#\s]/g,h,s,k=/\/$/,v=function(){function rt(n){return n.router&&n.router.parent==u}function ut(n){y&&y.config.isActive&&y.config.isActive(n)}function ht(t,i){var r,f;n.log("Navigation Complete",t,i);r=n.getModuleId(o);r&&u.trigger("router:navigation:from:"+r);o=t;ut(!1);y=i;ut(!0);f=n.getModuleId(o);f&&u.trigger("router:navigation:to:"+f);rt(t)||u.updateDocumentTitle(t,i);s.explicitNavigation=!1;s.navigatingBack=!1;u.trigger("router:navigation:complete",t,i,u)}function g(t,i){n.log("Navigation Cancelled");u.activeInstruction(y);y&&u.navigate(y.fragment,!1);p(!1);s.explicitNavigation=!1;s.navigatingBack=!1;u.trigger("router:navigation:cancelled",t,i,u)}function nt(t){n.log("Navigation Redirecting");p(!1);s.explicitNavigation=!1;s.navigatingBack=!1;u.navigate(t,{trigger:!0,replace:!0})}function tt(t,i,r){s.navigatingBack=!s.explicitNavigation&&o!=r.fragment;u.trigger("router:route:activating",i,r,u);t.activateItem(i,r.params).then(function(n){var e,f;n?(e=o,ht(i,r),rt(i)&&(f=r.fragment,r.queryString&&(f+="?"+r.queryString),i.router.loadUrl(f)),e==i&&(u.attached(),u.compositionComplete())):t.settings.lifecycleData&&t.settings.lifecycleData.redirect?nt(t.settings.lifecycleData.redirect):g(i,r);h&&(h.resolve(),h=null)}).fail(function(t){n.error(t)})}function ct(t,i,r){var f=u.guardRoute(i,r);f?f.then?f.then(function(u){u?n.isString(u)?nt(u):tt(t,i,r):g(i,r)}):n.isString(f)?nt(f):tt(t,i,r):g(i,r)}function ft(n,t,i){u.guardRoute?ct(n,t,i):tt(n,t,i)}function lt(n){return y&&y.config.moduleId==n.config.moduleId&&o&&(o.canReuseForRoute&&o.canReuseForRoute.apply(o,n.params)||!o.canReuseForRoute&&o.router&&o.router.loadUrl)}function et(){if(!p()){var t=b.shift();(b=[],t)&&(p(!0),u.activeInstruction(t),lt(t)?ft(i.create(),o,t):n.acquire(t.config.moduleId).then(function(i){var r=n.resolveObject(i);ft(w,r,t)}).fail(function(i){n.error("Failed to load routed module ("+t.config.moduleId+"). Details: "+i.message)}))}}function it(n){b.unshift(n);et()}function ot(n,t,i){for(var o,e,r=n.exec(t).slice(1),f=0;f<r.length;f++)o=r[f],r[f]=o?decodeURIComponent(o):null;return e=u.parseQueryString(i),e&&r.push(e),{params:r,queryParams:e}}function st(t){u.trigger("router:route:before-config",t,u);n.isRegExp(t)?t.routePattern=t.route:(t.title=t.title||u.convertRouteToTitle(t.route),t.moduleId=t.moduleId||u.convertRouteToModuleId(t.route),t.hash=t.hash||u.convertRouteToHash(t.route),t.routePattern=c(t.route));t.isActive=t.isActive||e.observable(!1);u.trigger("router:route:after-config",t,u);u.routes.push(t);u.route(t.routePattern,function(n,i){var r=ot(t.routePattern,n,i);it({fragment:n,queryString:i,config:t,params:r.params,queryParams:r.queryParams})})}function at(t){var f,i,o,r;if(n.isArray(t.route))for(f=t.isActive||e.observable(!1),i=0,o=t.route.length;i<o;i++)r=n.extend({},t),r.route=t.route[i],r.isActive=f,i>0&&delete r.nav,st(r);else st(t);return u}var b=[],p=e.observable(!1),o,y,w=i.create(),u={handlers:[],routes:[],navigationModel:e.observableArray([]),activeItem:w,isNavigating:e.computed(function(){var n=w(),t=p(),i=n&&n.router&&n.router!=u&&n.router.isNavigating()?!0:!1;return t||i}),activeInstruction:e.observable(null),__router__:!0};return r.includeIn(u),w.settings.areSameItem=function(n,t,i,r){return n==t?d(i,r):!1},u.parseQueryString=function(n){var u,t,i,f,r;if(!n||(t=n.split("&"),t.length==0))return null;for(u={},i=0;i<t.length;i++)(f=t[i],f!=="")&&(r=f.split("="),u[r[0]]=r[1]&&decodeURIComponent(r[1].replace(/\+/g," ")));return u},u.route=function(n,t){u.handlers.push({routePattern:n,callback:t})},u.loadUrl=function(t){var h=u.handlers,c=null,i=t,e=t.indexOf("?"),l,r,o;for(e!=-1&&(i=t.substring(0,e),c=t.substr(e+1)),u.relativeToParentRouter&&(l=this.parent.activeInstruction(),i=l.params.join("/"),i&&i.charAt(0)=="/"&&(i=i.substr(1)),i||(i=""),i=i.replace("//","/").replace("//","/")),i=i.replace(k,""),r=0;r<h.length;r++)if(o=h[r],o.routePattern.test(i))return o.callback(i,c),!0;return n.log("Route Not Found"),u.trigger("router:route:not-found",t,u),y&&f.navigate(y.fragment,{trigger:!1,replace:!0}),s.explicitNavigation=!1,s.navigatingBack=!1,!1},u.updateDocumentTitle=function(n,i){i.config.title?document.title=t.title?i.config.title+" | "+t.title:i.config.title:t.title&&(document.title=t.title)},u.navigate=function(n,t){return n&&n.indexOf("://")!=-1?(window.location.href=n,!0):(s.explicitNavigation=!0,f.navigate(n,t))},u.navigateBack=function(){f.navigateBack()},u.attached=function(){u.trigger("router:navigation:attached",o,y,u)},u.compositionComplete=function(){p(!1);u.trigger("router:navigation:composition-complete",o,y,u);et()},u.convertRouteToHash=function(n){if(u.relativeToParentRouter){var i=u.parent.activeInstruction(),t=i.config.hash+"/"+n;return f._hasPushState&&(t="/"+t),t.replace("//","/").replace("//","/")}return f._hasPushState?n:"#"+n},u.convertRouteToModuleId=function(n){return l(n)},u.convertRouteToTitle=function(n){var t=l(n);return t.substring(0,1).toUpperCase()+t.substring(1)},u.map=function(t,i){if(n.isArray(t)){for(var r=0;r<t.length;r++)u.map(t[r]);return u}return n.isString(t)||n.isRegExp(t)?(i?n.isString(i)&&(i={moduleId:i}):i={},i.route=t):i=t,at(i)},u.buildNavigationModel=function(t){for(var i,r=[],e=u.routes,o=t||100,f=0;f<e.length;f++)i=e[f],i.nav&&(n.isNumber(i.nav)||(i.nav=++o),r.push(i));return r.sort(function(n,t){return n.nav-t.nav}),u.navigationModel(r),u},u.mapUnknownRoutes=function(t,i){var e="*catchall",r=c(e);return u.route(r,function(o,s){var l=ot(r,o,s),h={fragment:o,queryString:s,config:{route:e,routePattern:r},params:l.params,queryParams:l.queryParams},c;if(t)if(n.isString(t))h.config.moduleId=t,i&&f.navigate(i,{trigger:!1,replace:!0});else if(n.isFunction(t)){if(c=t(h),c&&c.then){c.then(function(){u.trigger("router:route:before-config",h.config,u);u.trigger("router:route:after-config",h.config,u);it(h)});return}}else h.config=t,h.config.route=e,h.config.routePattern=r;else h.config.moduleId=o;u.trigger("router:route:before-config",h.config,u);u.trigger("router:route:after-config",h.config,u);it(h)}),u},u.reset=function(){return y=o=undefined,u.handlers=[],u.routes=[],u.off(),delete u.options,u},u.makeRelative=function(t){return n.isString(t)&&(t={moduleId:t,route:t}),t.moduleId&&!a(t.moduleId,"/")&&(t.moduleId+="/"),t.route&&!a(t.route,"/")&&(t.route+="/"),t.fromParent&&(u.relativeToParentRouter=!0),u.on("router:route:before-config").then(function(n){t.moduleId&&(n.moduleId=t.moduleId+n.moduleId);t.route&&(n.route=n.route===""?t.route.substring(0,t.route.length-1):t.route+n.route)}),u},u.createChildRouter=function(){var n=v();return n.parent=u,n},u};return s=v(),s.explicitNavigation=!1,s.navigatingBack=!1,s.targetIsThisWindow=function(n){var t=o(n.target).attr("target");return!t||t===window.name||t==="_self"||t==="top"&&window===window.top?!0:!1},s.activate=function(t){return n.defer(function(i){var r,u,e;if(h=i,s.options=n.extend({routeHandler:s.loadUrl},s.options,t),f.activate(s.options),f._hasPushState)for(r=s.routes,u=r.length;u--;)e=r[u],e.hash=e.hash.replace("#","");o(document).delegate("a","click",function(n){if(f._hasPushState){if(!n.altKey&&!n.ctrlKey&&!n.metaKey&&!n.shiftKey&&s.targetIsThisWindow(n)){var t=o(this).attr("href");t==null||t.charAt(0)==="#"||/^[a-z]+:/i.test(t)||(s.explicitNavigation=!0,n.preventDefault(),f.navigate(t))}}else s.explicitNavigation=!0});f.options.silent&&h&&(h.resolve(),h=null)}).promise()},s.deactivate=function(){f.deactivate()},s.install=function(){e.bindingHandlers.router={init:function(){return{controlsDescendantBindings:!0}},update:function(n,t,i,r,f){var o=e.utils.unwrapObservable(t())||{},h;o.__router__?o={model:o.activeItem(),attached:o.attached,compositionComplete:o.compositionComplete,activate:!1}:(h=e.utils.unwrapObservable(o.router||r.router)||s,o.model=h.activeItem(),o.attached=h.attached,o.compositionComplete=h.compositionComplete,o.activate=!1);u.compose(n,o,f)}};e.virtualElements.allowedBindings.router=!0},s});